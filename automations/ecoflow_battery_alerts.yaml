alias: EcoFlow - –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ —Å—Ç–∞–Ω –±–∞—Ç–∞—Ä–µ—ó
description: –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–∏–∑—å–∫–∏–π/–∫—Ä–∏—Ç–∏—á–Ω–∏–π –∑–∞—Ä—è–¥, –ø–µ—Ä–µ–≥—Ä—ñ–≤ —Ç–∞ –ø–æ–≤–Ω–∏–π –∑–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ—ó
triggers:
  # –ù–∏–∑—å–∫–∏–π –∑–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ—ó (<20%)
  - platform: numeric_state
    entity_id: sensor.ecoflow_delta_pro_3_system_battery_level
    below: 20
    for:
      minutes: 1
    id: low_battery
  # –ö—Ä–∏—Ç–∏—á–Ω–∏–π –∑–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ—ó (<10%)
  - platform: numeric_state
    entity_id: sensor.ecoflow_delta_pro_3_system_battery_level
    below: 10
    for:
      minutes: 1
    id: critical_battery
  # –í–∏—Å–æ–∫–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (>40¬∞C)
  - platform: numeric_state
    entity_id: sensor.ecoflow_delta_pro_3_max_cell_temperature
    above: 40
    for:
      minutes: 5
    id: high_temp
  # –ë–∞—Ç–∞—Ä–µ—è –∑–∞—Ä—è–¥–∂–µ–Ω–∞ (100%)
  - platform: state
    entity_id: binary_sensor.ecoflow_delta_pro_3_battery_full
    to: "on"
    for:
      minutes: 2
    id: battery_full
conditions:
  # –î–ª—è –Ω–∏–∑—å–∫–æ–≥–æ/–∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ –∑–∞—Ä—è–¥—É - –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ —î —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è
  - condition: or
    conditions:
      - condition: template
        value_template: "{{ trigger.id in ['high_temp', 'battery_full'] }}"
      - condition: and
        conditions:
          - condition: template
            value_template: "{{ trigger.id in ['low_battery', 'critical_battery'] }}"
          - condition: numeric_state
            entity_id: sensor.ecoflow_delta_pro_3_total_output_power
            above: 0
  # –î–ª—è –ø–æ–≤–Ω–æ–≥–æ –∑–∞—Ä—è–¥—É - –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ –∑–∞—Ä—è–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
  - condition: or
    conditions:
      - condition: template
        value_template: "{{ trigger.id != 'battery_full' }}"
      - condition: state
        entity_id: binary_sensor.ecoflow_delta_pro_3_charging
        state: "on"
actions:
  - variables:
      # –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
      alert_type: "{{ trigger.id }}"
      
      # –ó–∞–≥–∞–ª—å–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
      battery_level: "{{ states('sensor.ecoflow_delta_pro_3_system_battery_level') | round(0) }}"
      battery_health: "{{ states('sensor.ecoflow_delta_pro_3_battery_health') | round(0) }}"
      battery_temp: "{{ states('sensor.ecoflow_delta_pro_3_max_cell_temperature') | round(1) }}"
      discharge_remaining_time: "{{ states('sensor.ecoflow_delta_pro_3_system_discharge_remaining_time') }}"
      charge_remaining_time: "{{ states('sensor.ecoflow_delta_pro_3_system_charge_remaining_time') }}"
      output_power: "{{ states('sensor.ecoflow_delta_pro_3_total_output_power') | round(0) }}"
      cycles: "{{ states('sensor.ecoflow_delta_pro_3_cycles') }}"
      is_charging: "{{ is_state('binary_sensor.ecoflow_delta_pro_3_charging', 'on') }}"
      charge_power: "{{ states('number.ecoflow_delta_pro_3_ac_charging_power') }}"
      
      # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
      notification_title: |
        {% if alert_type == 'low_battery' %}
          ‚ö†Ô∏è –ù–∏–∑—å–∫–∏–π –∑–∞—Ä—è–¥ EcoFlow
        {% elif alert_type == 'critical_battery' %}
          üö® –ö–†–ò–¢–ò–ß–ù–ò–ô –∑–∞—Ä—è–¥ EcoFlow!
        {% elif alert_type == 'high_temp' %}
          üå°Ô∏è EcoFlow –ø–µ—Ä–µ–≥—Ä—ñ–≤–∞—î—Ç—å—Å—è!
        {% elif alert_type == 'battery_full' %}
          ‚úÖ EcoFlow –ø–æ–≤–Ω—ñ—Å—Ç—é –∑–∞—Ä—è–¥–∂–µ–Ω–∏–π
        {% endif %}
      
      notification_message: |
        {% if alert_type == 'low_battery' %}
          üîã {{ battery_level }}%
          ‚è±Ô∏è {{ discharge_remaining_time }}
          ‚ö° {{ output_power }}W
        {% elif alert_type == 'critical_battery' %}
          üîã {{ battery_level }}%!
          ‚è±Ô∏è {{ discharge_remaining_time }}
          ‚ö° {{ output_power }}W
          ‚ö†Ô∏è –¢–ï–†–ú–Ü–ù–û–í–û –ó–ê–†–Ø–î–ñ–ê–ù–ù–Ø!
        {% elif alert_type == 'high_temp' %}
          üå°Ô∏è {{ battery_temp }}¬∞C
          ‚ö†Ô∏è –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤–µ–Ω—Ç–∏–ª—è—Ü—ñ—é!
          üîã {{ battery_level }}%
          ‚ö° {{ output_power }}W
          {% if is_charging %}
          üîå {{ charge_power }}W
          {% endif %}
        {% elif alert_type == 'battery_full' %}
          üîã {{ battery_level }}%
          ‚úÖ –ú–æ–∂–Ω–∞ –≤–∏–º–∏–∫–∞—Ç–∏ –∑–∞—Ä—è–¥–∂–∞–Ω–Ω—è
          üìä {{ battery_health }}%
          üîÑ {{ cycles }}
        {% endif %}
  
  - action: notify.notify
    data:
      title: "{{ notification_title }}"
      message: "{{ notification_message }}"
    enabled: true

mode: single

