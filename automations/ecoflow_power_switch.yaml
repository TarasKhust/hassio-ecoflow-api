alias: EcoFlow - –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –¥–∂–µ—Ä–µ–ª–∞ –∂–∏–≤–ª–µ–Ω–Ω—è
description: –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–∏ –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—ñ –º—ñ–∂ –º—ñ—Å—å–∫–æ—é –º–µ—Ä–µ–∂–µ—é —Ç–∞ –±–∞—Ç–∞—Ä–µ—î—é
triggers:
  # –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –Ω–∞ –º–µ—Ä–µ–∂—É
  - platform: state
    entity_id: binary_sensor.ecoflow_delta_pro_3_ac_input_connected
    to: "on"
    for:
      seconds: 10
    id: switch_to_grid
  # –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –Ω–∞ –±–∞—Ç–∞—Ä–µ—é
  - platform: state
    entity_id: binary_sensor.ecoflow_delta_pro_3_ac_input_connected
    to: "off"
    for:
      seconds: 10
    id: switch_to_battery
conditions:
  # –î–ª—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –Ω–∞ –±–∞—Ç–∞—Ä–µ—é - –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ —Ä–æ–∑—Ä—è–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
  - condition: or
    conditions:
      - condition: template
        value_template: "{{ trigger.id == 'switch_to_grid' }}"
      - condition: and
        conditions:
          - condition: template
            value_template: "{{ trigger.id == 'switch_to_battery' }}"
          - condition: state
            entity_id: binary_sensor.ecoflow_delta_pro_3_discharging
            state: "on"
actions:
  - variables:
      # –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ä–µ–∂–∏–º —Ä–æ–±–æ—Ç–∏
      is_grid_mode: "{{ trigger.id == 'switch_to_grid' }}"
      
      # –ó–∞–≥–∞–ª—å–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
      battery_level: "{{ states('sensor.ecoflow_delta_pro_3_system_battery_level') | round(0) }}"
      battery_temp: "{{ states('sensor.ecoflow_delta_pro_3_max_cell_temperature') | round(1) }}"
      
      # –î–ª—è —Ä–µ–∂–∏–º—É –º–µ—Ä–µ–∂—ñ
      charge_power: "{{ states('sensor.ecoflow_delta_pro_3_ac_input_power') | round(0) }}"
      charge_remaining_time: "{{ states('sensor.ecoflow_delta_pro_3_system_charge_remaining_time') }}"
      
      # –î–ª—è —Ä–µ–∂–∏–º—É –±–∞—Ç–∞—Ä–µ—ó
      output_power: "{{ states('sensor.ecoflow_delta_pro_3_total_output_power') | round(0) }}"
      discharge_remaining_time: "{{ states('sensor.ecoflow_delta_pro_3_system_discharge_remaining_time') }}"
      
      # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      notification_title: |
        {% if is_grid_mode %}
          üè† –ñ–∏–≤–ª–µ–Ω–Ω—è –≤—ñ–¥ –º–µ—Ä–µ–∂—ñ
        {% else %}
          üîã –ñ–∏–≤–ª–µ–Ω–Ω—è –≤—ñ–¥ EcoFlow
        {% endif %}
      
      notification_message: |
        {% if is_grid_mode %}
          ‚ö° {{ charge_power }}W
          ‚è±Ô∏è {{ charge_remaining_time }}
          üîã {{ battery_level }}%
        {% else %}
          ‚ö° {{ output_power }}W
          ‚è±Ô∏è {{ discharge_remaining_time }}
          üîã {{ battery_level }}%
        {% endif %}
  
  - action: notify.notify
    data:
      title: "{{ notification_title }}"
      message: "{{ notification_message }}"
    enabled: true

mode: single

