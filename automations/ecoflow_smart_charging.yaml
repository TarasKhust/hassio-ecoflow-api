alias: EcoFlow - –†–æ–∑—É–º–Ω–µ –∑–∞—Ä—è–¥–∂–∞–Ω–Ω—è
description: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–µ–≥—É–ª—é—î –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å –∑–∞—Ä—è–¥–∂–∞–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≥—Ä–∞—Ñ—ñ–∫—É –≤—ñ–¥–∫–ª—é—á–µ–Ω—å —Ç–∞ —á–∞—Å—É –∑–∞—Ä—è–¥–∂–∞–Ω–Ω—è –¥–æ 100%
triggers:
  # –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (5 —Ö–≤–∏–ª–∏–Ω - –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Å–∏—Ç—É–∞—Ü—ñ–π)
  - platform: time_pattern
    minutes: /5
    id: check_5min
  # –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (10 —Ö–≤–∏–ª–∏–Ω - –¥–ª—è —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ —á–∞—Å—É –¥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è)
  - platform: time_pattern
    minutes: /10
    id: check_10min
  # –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ (15 —Ö–≤–∏–ª–∏–Ω - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π)
  - platform: time_pattern
    minutes: /15
    id: check_15min
  # –ó–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
  - platform: state
    entity_id: sensor.yasno_kiiv_dtek_3_2_status_today
  # –ó–º—ñ–Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–æ–≥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
  - platform: state
    entity_id: sensor.yasno_kiiv_dtek_3_2_next_planned_outage
  # –ó–º—ñ–Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —ñ–º–æ–≤—ñ—Ä–Ω–æ–≥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
  - platform: state
    entity_id: sensor.yasno_kiiv_dtek_3_2_next_probable_outage
  # –ó–º—ñ–Ω–∞ —á–∞—Å—É –∑–∞—Ä—è–¥–∂–∞–Ω–Ω—è –¥–æ 100%
  - platform: state
    entity_id: sensor.ecoflow_delta_pro_3_system_charge_remaining_time
  # –ó–º—ñ–Ω–∞ –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ –∑–∞—Ä—è–¥–∫–∏ (–¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—ñ—Å–ª—è –∑–º—ñ–Ω–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å)
  - platform: numeric_state
    entity_id: sensor.ecoflow_delta_pro_3_ac_input_power
    above: 0
    for:
      seconds: 60
conditions:
  # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —â–æ –∑–∞—Ä—è–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
  - condition: numeric_state
    entity_id: sensor.ecoflow_delta_pro_3_ac_input_power
    above: 0
  # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —â–æ –±–∞—Ç–∞—Ä–µ—è –Ω–µ –ø–æ–≤–Ω–∞ (–¥–ª—è –±–µ–∑–ø–µ–∫–∏)
  - condition: numeric_state
    entity_id: sensor.ecoflow_delta_pro_3_system_battery_level
    below: 100
  # –ê–¥–∞–ø—Ç–∏–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ–Ω—Ç–µ—Ä–≤–∞–ª—É –¥–ª—è time_pattern —Ç—Ä–∏–≥–µ—Ä—ñ–≤
  - condition: or
    conditions:
      # –Ø–∫—â–æ –Ω–µ time_pattern —Ç—Ä–∏–≥–µ—Ä - –∑–∞–≤–∂–¥–∏ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏
      - condition: template
        value_template: "{{ trigger.id not in ['check_5min', 'check_10min', 'check_15min'] }}"
      # –î–ª—è check_5min - –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —è–∫—â–æ —á–∞—Å –¥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è < 60 —Ö–≤
      - condition: and
        conditions:
          - condition: template
            value_template: "{{ trigger.id == 'check_5min' }}"
          - condition: template
            value_template: |
              {% set planned = states('sensor.yasno_kiiv_dtek_3_2_next_planned_outage') %}
              {% set probable = states('sensor.yasno_kiiv_dtek_3_2_next_probable_outage') %}
              {% set next_outage = planned if planned not in ['unavailable', 'unknown', 'none', ''] else (probable if probable not in ['unavailable', 'unknown', 'none', ''] else 'none') %}
              {% if next_outage != 'none' %}
                {% set outage_min = ((as_timestamp(next_outage) - as_timestamp(now())) / 60) | int %}
                {{ outage_min < 60 }}
              {% else %}
                False
              {% endif %}
      # –î–ª—è check_10min - –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —è–∫—â–æ —á–∞—Å –¥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è < 180 —Ö–≤ –∞–ª–µ >= 60 —Ö–≤
      - condition: and
        conditions:
          - condition: template
            value_template: "{{ trigger.id == 'check_10min' }}"
          - condition: template
            value_template: |
              {% set planned = states('sensor.yasno_kiiv_dtek_3_2_next_planned_outage') %}
              {% set probable = states('sensor.yasno_kiiv_dtek_3_2_next_probable_outage') %}
              {% set next_outage = planned if planned not in ['unavailable', 'unknown', 'none', ''] else (probable if probable not in ['unavailable', 'unknown', 'none', ''] else 'none') %}
              {% if next_outage != 'none' %}
                {% set outage_min = ((as_timestamp(next_outage) - as_timestamp(now())) / 60) | int %}
                {{ outage_min >= 60 and outage_min < 180 }}
              {% else %}
                False
              {% endif %}
      # –î–ª—è check_15min - –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —è–∫—â–æ —á–∞—Å –¥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è >= 180 —Ö–≤ –∞–±–æ –Ω–µ–º–∞—î –≤—ñ–¥–∫–ª—é—á–µ–Ω—å
      - condition: and
        conditions:
          - condition: template
            value_template: "{{ trigger.id == 'check_15min' }}"
          - condition: template
            value_template: |
              {% set planned = states('sensor.yasno_kiiv_dtek_3_2_next_planned_outage') %}
              {% set probable = states('sensor.yasno_kiiv_dtek_3_2_next_probable_outage') %}
              {% set next_outage = planned if planned not in ['unavailable', 'unknown', 'none', ''] else (probable if probable not in ['unavailable', 'unknown', 'none', ''] else 'none') %}
              {% if next_outage != 'none' %}
                {% set outage_min = ((as_timestamp(next_outage) - as_timestamp(now())) / 60) | int %}
                {{ outage_min >= 180 }}
              {% else %}
                True
              {% endif %}
actions:
  - variables:
      # –°—Ç–∞—Ç—É—Å –≤—ñ–¥–∫–ª—é—á–µ–Ω—å —Å—å–æ–≥–æ–¥–Ω—ñ
      status: "{{ states('sensor.yasno_kiiv_dtek_3_2_status_today') }}"
      
      # –†—ñ–≤–µ–Ω—å –±–∞—Ç–∞—Ä–µ—ó
      battery_level: >-
        {{ states('sensor.ecoflow_delta_pro_3_system_battery_level') | float(0) }}
      
      # –ü–æ—Ç–æ—á–Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å –∑–∞—Ä—è–¥–∂–∞–Ω–Ω—è
      current_charge_power: "{{ states('number.ecoflow_delta_pro_3_ac_charging_power') | int(1000) }}"
      
      # –ß–∞—Å –∑–∞—Ä—è–¥–∂–∞–Ω–Ω—è –¥–æ 100% (–≤ —Ö–≤–∏–ª–∏–Ω–∞—Ö)
      charge_time_min: "{{ states('sensor.ecoflow_delta_pro_3_system_charge_remaining_time') | int(0) }}"
      
      # –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (—Å–ø–æ—á–∞—Ç–∫—É –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–µ, –ø–æ—Ç—ñ–º —ñ–º–æ–≤—ñ—Ä–Ω–µ)
      planned_outage: "{{ states('sensor.yasno_kiiv_dtek_3_2_next_planned_outage') }}"
      probable_outage: "{{ states('sensor.yasno_kiiv_dtek_3_2_next_probable_outage') }}"
      next_outage: |
        {% if planned_outage not in ['unavailable', 'unknown', 'none', ''] %}
          {{ planned_outage }}
        {% elif probable_outage not in ['unavailable', 'unknown', 'none', ''] %}
          {{ probable_outage }}
        {% else %}
          none
        {% endif %}
      
      # –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è —Ç–∞ —Å–µ–Ω—Å–æ—Ä–∞
      electricity_event_type: "{{ state_attr('sensor.yasno_kiiv_dtek_3_2_electricity', 'event_type') }}"
      electricity_event_start: "{{ state_attr('sensor.yasno_kiiv_dtek_3_2_electricity', 'event_start') }}"
      electricity_event_end: "{{ state_attr('sensor.yasno_kiiv_dtek_3_2_electricity', 'event_end') }}"
      
      # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
      outage_duration_min: |
        {% if electricity_event_start and electricity_event_end %}
          {% set start = as_timestamp(electricity_event_start) %}
          {% set end = as_timestamp(electricity_event_end) %}
          {{ ((end - start) / 60) | int }}
        {% else %}
          0
        {% endif %}
      
      # –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∏–ø—É –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑ –¥–µ—Ç–∞–ª—è–º–∏
      outage_type: |
        {% if status == 'emergency_shutdowns' %}
          üö® –ï–∫—Å—Ç—Ä–µ–Ω–µ
        {% elif electricity_event_type == 'NotPlanned' %}
          ‚ö†Ô∏è –ù–µ–∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–µ
        {% elif planned_outage not in ['unavailable', 'unknown', 'none', ''] %}
          üìÖ –ó–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–µ
        {% elif probable_outage not in ['unavailable', 'unknown', 'none', ''] %}
          ‚ùì –Ü–º–æ–≤—ñ—Ä–Ω–µ
        {% else %}
          ‚ùì –ù–µ–≤—ñ–¥–æ–º–µ
        {% endif %}
      
      # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —á–∞—Å—É –¥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≤ —Ö–≤–∏–ª–∏–Ω–∞—Ö
      outage_time_min: |
        {% if next_outage not in ['unavailable', 'unknown', 'none', ''] %}
          {{ ((as_timestamp(next_outage) - as_timestamp(now())) / 60) | int }}
        {% else %}
          9999
        {% endif %}
      
      # –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –±–∞—Ç–∞—Ä–µ—ó –¥–ª—è –±–µ–∑–ø–µ–∫–∏
      battery_health: "{{ states('sensor.ecoflow_delta_pro_3_battery_health') | float(100) }}"
      battery_temp: >-
        {{ states('sensor.ecoflow_delta_pro_3_max_cell_temperature') | float(25) }}
      
      # –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ—ó –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ
      optimal_power: >
        {# üö® –ê–í–ê–†–Ü–ô–ù–ò–ô –†–ï–ñ–ò–ú - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å #}
        {% if status == 'emergency_shutdowns' %}
          2900

        {# üå°Ô∏è –ü–ï–†–ï–ì–†–Ü–í - –∑–º–µ–Ω—à—É—î–º–æ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å #}
        {% elif battery_temp > 40 %}
          800

        {# üìä –ó–î–û–†–û–í'–Ø –ë–ê–¢–ê–†–ï–á –ù–ò–ó–¨–ö–ï (<80%) - –æ–±–µ—Ä–µ–∂–Ω–∏–π —Ä–µ–∂–∏–º #}
        {% elif battery_health < 80 %}
          1200

        {# ‚è∞ –ö–†–ò–¢–ò–ß–ù–û –ú–ê–õ–û –ß–ê–°–£ (<30 —Ö–≤ –¥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è) - –º–∞–∫—Å–∏–º—É–º #}
        {% elif outage_time_min < 30 and outage_time_min < 9999 %}
          2900

        {# ‚ö° –ü–û–¢–†–Ü–ë–ù–û –ó–ê–†–Ø–î–ò–¢–ò –®–í–ò–î–®–ï (—á–∞—Å –∑–∞—Ä—è–¥—É > —á–∞—Å –¥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è) #}
        {% elif charge_time_min > outage_time_min and outage_time_min < 9999 %}
          {# –†–æ–∑—Ä–∞—Ö–æ–≤—É—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω—É –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å –∑ –∑–∞–ø–∞—Å–æ–º 20% #}
          {% set needed_power = ((charge_time_min / outage_time_min) * current_charge_power * 1.2) | int %}
          {# –û–±–º–µ–∂—É—î–º–æ: –º—ñ–Ω 800W, –º–∞–∫—Å 2900W #}
          {{ [needed_power, 2900] | min if needed_power > 800 else 800 }}

        {# üîå –î–û–°–¢–ê–¢–ù–¨–û –ß–ê–°–£ (–∑–∞—Ä—è–¥ –∑–∞–π–º–µ <50% –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ —á–∞—Å—É) - –µ–∫–æ–Ω–æ–º–Ω–∏–π —Ä–µ–∂–∏–º #}
        {% elif charge_time_min < (outage_time_min * 0.5) and outage_time_min < 9999 %}
          1000

        {# üì∂ –ù–ï–í–Ü–î–û–ú–ò–ô –°–¢–ê–¢–£–° –ê–ë–û –ù–ï–ú–ê–Ñ –í–Ü–î–ö–õ–Æ–ß–ï–ù–¨ - —Å–µ—Ä–µ–¥–Ω—è –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å #}
        {% elif status in ['waiting_for_schedule', 'unknown'] or outage_time_min >= 9999 %}
          1200

        {# ‚úÖ –ù–û–†–ú–ê–õ–¨–ù–ò–ô –†–ï–ñ–ò–ú - –ø–æ—Ç–æ—á–Ω–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å #}
        {% else %}
          {{ current_charge_power }}
        {% endif %}
      
      # –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ä–µ–∂–∏–º—É –∑–∞—Ä—è–¥–∂–∞–Ω–Ω—è –¥–ª—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      charge_mode: |
        {% if optimal_power | int >= 2500 %}
          üö® –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π
        {% elif optimal_power | int >= 2000 %}
          ‚ö° –®–≤–∏–¥–∫–∏–π
        {% elif optimal_power | int >= 1500 %}
          üîã –°–µ—Ä–µ–¥–Ω—ñ–π
        {% elif optimal_power | int >= 1000 %}
          üîå –ó–≤–∏—á–∞–π–Ω–∏–π
        {% else %}
          üêå –ü–æ–≤—ñ–ª—å–Ω–∏–π
        {% endif %}
  
  # –ó–º—ñ–Ω—é—î–º–æ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ä—ñ–∑–Ω–∏—Ü—è > 200W
  - condition: template
    value_template: "{{ (optimal_power | int - current_charge_power) | abs > 200 }}"
  
  # –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ –∑–∞—Ä—è–¥–∂–∞–Ω–Ω—è
  - action: number.set_value
    target:
      entity_id: number.ecoflow_delta_pro_3_ac_charging_power
    data:
      value: "{{ optimal_power | int }}"
  
  # –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –∑–º—ñ–Ω—É
  - action: notify.notify
    data:
      title: "{{ charge_mode }} –∑–∞—Ä—è–¥"
      message: >
        ‚ö° {{ optimal_power }}W
        {% if outage_time_min < 9999 %}
        ‚è∞ {{ outage_time_min }}—Ö–≤ ({{ outage_type }}{% if outage_duration_min > 0 %}, {{ outage_duration_min }}—Ö–≤{% endif %})
        {% endif %}
        ‚è±Ô∏è {{ charge_time_min }}—Ö–≤
        üîã {{ battery_level | round(0) }}%
    enabled: true

mode: single

