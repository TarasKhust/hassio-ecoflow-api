alias: EcoFlow - Розумне заряджання (оптимізовано)
  description: Автоматично регулює потужність заряджання на основі графіку відключень
    та часу заряджання до 100%
  triggers:
  - minutes: /5
    id: check_5min
    trigger: time_pattern
  - minutes: /10
    id: check_10min
    trigger: time_pattern
  - minutes: /15
    id: check_15min
    trigger: time_pattern
  - entity_id: sensor.yasno_kiiv_dtek_3_2_status_today
    trigger: state
  - entity_id: sensor.yasno_kiiv_dtek_3_2_next_planned_outage
    trigger: state
  - entity_id: sensor.yasno_kiiv_dtek_3_2_next_probable_outage
    trigger: state
  - entity_id: sensor.ecoflow_delta_pro_3_system_charge_remaining_time
    trigger: state
  - entity_id: sensor.ecoflow_delta_pro_3_ac_input_power
    above: 0
    for:
      seconds: 60
    trigger: numeric_state
  conditions:
  - condition: numeric_state
    entity_id: sensor.ecoflow_delta_pro_3_ac_input_power
    above: 0
  - condition: numeric_state
    entity_id: sensor.ecoflow_delta_pro_3_system_battery_level
    below: 95
  - condition: template
    value_template: '{{ states(''sensor.yasno_kiiv_dtek_3_2_status_today'') not in
      [''unavailable'', ''unknown''] }}'
  - condition: or
    conditions:
    - condition: template
      value_template: '{{ trigger.id not in [''check_5min'', ''check_10min'', ''check_15min'']
        }}'
    - condition: and
      conditions:
      - condition: template
        value_template: '{{ trigger.id == ''check_5min'' }}'
      - condition: template
        value_template: "{% set planned = states('sensor.yasno_kiiv_dtek_3_2_next_planned_outage')
          %} {% set probable = states('sensor.yasno_kiiv_dtek_3_2_next_probable_outage')
          %} {% set next_outage = planned if planned not in ['unavailable', 'unknown',
          'none', ''] else (probable if probable not in ['unavailable', 'unknown',
          'none', ''] else 'none') %} {% if next_outage != 'none' %}\n  {% set outage_min
          = ((as_timestamp(next_outage) - as_timestamp(now())) / 60) | int %}\n  {{
          outage_min < 60 }}\n{% else %}\n  False\n{% endif %}\n"
    - condition: and
      conditions:
      - condition: template
        value_template: '{{ trigger.id == ''check_10min'' }}'
      - condition: template
        value_template: "{% set planned = states('sensor.yasno_kiiv_dtek_3_2_next_planned_outage')
          %} {% set probable = states('sensor.yasno_kiiv_dtek_3_2_next_probable_outage')
          %} {% set next_outage = planned if planned not in ['unavailable', 'unknown',
          'none', ''] else (probable if probable not in ['unavailable', 'unknown',
          'none', ''] else 'none') %} {% if next_outage != 'none' %}\n  {% set outage_min
          = ((as_timestamp(next_outage) - as_timestamp(now())) / 60) | int %}\n  {{
          outage_min >= 60 and outage_min < 180 }}\n{% else %}\n  False\n{% endif
          %}\n"
    - condition: and
      conditions:
      - condition: template
        value_template: '{{ trigger.id == ''check_15min'' }}'
      - condition: template
        value_template: "{% set planned = states('sensor.yasno_kiiv_dtek_3_2_next_planned_outage')
          %} {% set probable = states('sensor.yasno_kiiv_dtek_3_2_next_probable_outage')
          %} {% set next_outage = planned if planned not in ['unavailable', 'unknown',
          'none', ''] else (probable if probable not in ['unavailable', 'unknown',
          'none', ''] else 'none') %} {% if next_outage != 'none' %}\n  {% set outage_min
          = ((as_timestamp(next_outage) - as_timestamp(now())) / 60) | int %}\n  {{
          outage_min >= 180 }}\n{% else %}\n  True\n{% endif %}\n"
  actions:
  - variables:
      status: '{{ states(''sensor.yasno_kiiv_dtek_3_2_status_today'') }}'
      battery_level: '{{ states(''sensor.ecoflow_delta_pro_3_system_battery_level'')
        | float(0) | round(0) }}'
      current_charge_power: '{{ states(''number.ecoflow_delta_pro_3_ac_charging_power'')
        | int(1000) }}'
      charge_time_min: '{{ (states(''sensor.ecoflow_delta_pro_3_system_charge_remaining_time'')
        | float(0) * 60) | int }}'
      planned_outage: '{{ states(''sensor.yasno_kiiv_dtek_3_2_next_planned_outage'')
        }}'
      probable_outage: '{{ states(''sensor.yasno_kiiv_dtek_3_2_next_probable_outage'')
        }}'
      battery_temp: '{{ states(''sensor.ecoflow_delta_pro_3_max_cell_temperature'')
        | float(25) }}'
      battery_health: '{{ states(''sensor.ecoflow_delta_pro_3_battery_health'') |
        float(100) }}'
      outage_time_min: "{% if planned_outage not in ['unavailable', 'unknown', 'none',
        ''] %}\n  {{ ((as_timestamp(planned_outage) - as_timestamp(now())) / 60) |
        int }}\n{% elif probable_outage not in ['unavailable', 'unknown', 'none',
        ''] %}\n  {{ ((as_timestamp(probable_outage) - as_timestamp(now())) / 60)
        | int }}\n{% else %}\n  9999\n{% endif %}\n"
      outage_type: "{% if planned_outage not in ['unavailable', 'unknown', 'none',
        ''] %}\n  \U0001F4C5 Заплановане\n{% elif status == 'emergency_shutdowns'
        %}\n  \U0001F6A8 Екстрене\n{% elif probable_outage not in ['unavailable',
        'unknown', 'none', ''] %}\n  ❓ Імовірне\n{% else %}\n  ❓ Невідоме\n{% endif
        %}\n"
      optimal_power: "{% if charge_time_min > outage_time_min and outage_time_min
        < 9999 %}\n  {% set needed_power = ((charge_time_min / outage_time_min) *
        current_charge_power * 1.2) | int %}\n  {{ [needed_power, 2900] | min if needed_power
        > 800 else 800 }}\n{% elif charge_time_min < (outage_time_min * 0.5) and outage_time_min
        < 9999 %}\n  {% if battery_temp >= 38 %}800\n  {% elif battery_temp >= 35
        %}1000\n  {% elif battery_temp >= 32 %}1200\n  {% else %}1000{% endif %}\n{%
        elif status == 'emergency_shutdowns' %}\n  2900\n{% else %}\n  {% if battery_temp
        >= 38 %}800\n  {% elif battery_temp >= 35 %}1200\n  {% elif battery_temp >=
        32 %}1500\n  {% elif battery_health < 80 %}1200\n  {% else %}1200{% endif
        %}\n{% endif %}\n"
      charge_mode: "{% if optimal_power | int >= 2500 %}\n  \U0001F6A8 Максимальний\n{%
        elif optimal_power | int >= 2000 %}\n  ⚡ Швидкий\n{% elif optimal_power |
        int >= 1500 %}\n  \U0001F50B Середній\n{% elif optimal_power | int >= 1000
        %}\n  \U0001F50C Звичайний\n{% else %}\n  \U0001F40C Повільний\n{% endif %}\n"
      charge_remaining_time: '{% set time_hours = states(''sensor.ecoflow_delta_pro_3_system_charge_remaining_time'')
        | float(0) %}

        {% set total_min = (time_hours * 60) | int %}

        {{ (total_min / 60) | int }}h {{ (total_min % 60) | int }}m

        '
      status_message: "{% if outage_time_min < 30 %}\U0001F4A1 Критично мало часу!\n{%
        elif charge_time_min > outage_time_min and outage_time_min < 9999 %}\U0001F4A1
        Не встигнемо зарядити\n{% elif charge_time_min < (outage_time_min * 0.5) and
        outage_time_min < 9999 %}\U0001F4A1 Достатньо часу\n{% elif status == 'emergency_shutdowns'
        %}\U0001F4A1 Аварійний режим\n{% elif battery_temp >= 38 %}\U0001F4A1 Критична
        температура!\n{% elif battery_temp >= 35 %}\U0001F4A1 Підвищена температура\n{%
        elif battery_temp >= 32 %}\U0001F4A1 Тепла батарея\n{% elif battery_health
        < 80 %}\U0001F4A1 Низьке здоров'я батареї\n{% else %}\U0001F4A1 Стандартний
        режим{% endif %}\n"
  - condition: template
    value_template: '{{ (optimal_power | int - current_charge_power) | abs > 200 }}'
  - action: number.set_value
    target:
      entity_id: number.ecoflow_delta_pro_3_ac_charging_power
    data:
      value: '{{ optimal_power | int }}'
  - action: notify.notify
    data:
      title: '{{ charge_mode }} заряд'
      message: "⚡ {{ current_charge_power }}W → {{ optimal_power }}W \U0001F50B {{
        battery_level }}% ({{ charge_remaining_time }}) \U0001F321️ {{ battery_temp
        | round(1) }}°C\n{% if outage_time_min < 9999 %}\n  ⏰ {{ outage_type }} через
        {{ outage_time_min / 60 }}г\n{% else %}\n  \U0001F4F6 Відключень немає\n{%
        endif %}\n{{ status_message }}\n"
    enabled: true
  mode: single
