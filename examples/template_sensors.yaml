# Template Sensors for Delta Pro 3
# Add these to your configuration.yaml or templates.yaml

template:
  - sensor:
      # Estimated Cycles based on State of Health
      - name: "Delta Pro 3 Estimated Cycles"
        unique_id: delta_pro_3_estimated_cycles
        state: >
          {% set soh_bms = states('sensor.delta_pro_3_state_of_health_bms') | float(100) %}
          {% set soh_cms = states('sensor.delta_pro_3_state_of_health_cms') | float(100) %}
          {% set soh = (soh_bms + soh_cms) / 2 %}
          {% if soh >= 100 %}
            0
          {% elif soh >= 80 %}
            {{ ((100 - soh) * 10) | round(0) }}
          {% else %}
            {{ ((100 - soh) * 15) | round(0) }}
          {% endif %}
        unit_of_measurement: "cycles"
        icon: mdi:battery-heart-variant
        attributes:
          calculation: "Based on average SOH"
          formula: "(100 - SOH) Ã— 10"
          note: "Estimated value, not from API"

      # Battery Health Status
      - name: "Delta Pro 3 Battery Health Status"
        unique_id: delta_pro_3_battery_health_status
        state: >
          {% set soh = states('sensor.delta_pro_3_state_of_health_bms') | float(100) %}
          {% if soh >= 95 %}
            Excellent
          {% elif soh >= 85 %}
            Good
          {% elif soh >= 75 %}
            Fair
          {% elif soh >= 60 %}
            Poor
          {% else %}
            Critical
          {% endif %}
        icon: >
          {% set soh = states('sensor.delta_pro_3_state_of_health_bms') | float(100) %}
          {% if soh >= 95 %}
            mdi:battery-heart
          {% elif soh >= 85 %}
            mdi:battery-check
          {% elif soh >= 75 %}
            mdi:battery-medium
          {% elif soh >= 60 %}
            mdi:battery-low
          {% else %}
            mdi:battery-alert
          {% endif %}

      # Charging Status
      - name: "Delta Pro 3 Charging Status"
        unique_id: delta_pro_3_charging_status
        state: >
          {% set ac_charging = states('binary_sensor.delta_pro_3_ac_charging') %}
          {% set solar_h = states('binary_sensor.delta_pro_3_solar_charging_high') %}
          {% set solar_l = states('binary_sensor.delta_pro_3_solar_charging_low') %}
          {% set soc = states('sensor.delta_pro_3_battery_level_bms') | float(0) %}
          
          {% if ac_charging == 'on' and (solar_h == 'on' or solar_l == 'on') %}
            Charging (AC + Solar)
          {% elif ac_charging == 'on' %}
            Charging (AC)
          {% elif solar_h == 'on' or solar_l == 'on' %}
            Charging (Solar)
          {% elif soc >= 99 %}
            Fully Charged
          {% else %}
            Not Charging
          {% endif %}
        icon: >
          {% set ac_charging = states('binary_sensor.delta_pro_3_ac_charging') %}
          {% set solar = states('binary_sensor.delta_pro_3_solar_charging_high') %}
          {% if ac_charging == 'on' or solar == 'on' %}
            mdi:battery-charging
          {% else %}
            mdi:battery
          {% endif %}

      # Total Energy Flow
      - name: "Delta Pro 3 Net Power Flow"
        unique_id: delta_pro_3_net_power_flow
        state: >
          {% set power_in = states('sensor.delta_pro_3_total_input_power') | float(0) %}
          {% set power_out = states('sensor.delta_pro_3_total_output_power') | float(0) %}
          {{ (power_in - power_out) | round(1) }}
        unit_of_measurement: "W"
        device_class: power
        icon: >
          {% set power_in = states('sensor.delta_pro_3_total_input_power') | float(0) %}
          {% set power_out = states('sensor.delta_pro_3_total_output_power') | float(0) %}
          {% if power_in > power_out %}
            mdi:battery-charging
          {% elif power_out > power_in %}
            mdi:battery-minus
          {% else %}
            mdi:battery
          {% endif %}
        attributes:
          input_power: "{{ states('sensor.delta_pro_3_total_input_power') }}"
          output_power: "{{ states('sensor.delta_pro_3_total_output_power') }}"

      # Battery Runtime Estimate
      - name: "Delta Pro 3 Runtime at Current Load"
        unique_id: delta_pro_3_runtime_estimate
        state: >
          {% set capacity = states('sensor.delta_pro_3_full_energy_capacity') | float(8192) %}
          {% set soc = states('sensor.delta_pro_3_battery_level_bms') | float(100) %}
          {% set power_out = states('sensor.delta_pro_3_total_output_power') | float(0) %}
          
          {% if power_out > 0 %}
            {% set available_wh = (capacity * soc / 100) %}
            {% set hours = available_wh / power_out %}
            {{ (hours * 60) | round(0) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "min"
        device_class: duration
        icon: mdi:timer-outline
        attributes:
          note: "Estimated runtime at current load"

      # Charge Time Estimate
      - name: "Delta Pro 3 Charge Time at Current Rate"
        unique_id: delta_pro_3_charge_time_estimate
        state: >
          {% set capacity = states('sensor.delta_pro_3_full_energy_capacity') | float(8192) %}
          {% set soc = states('sensor.delta_pro_3_battery_level_bms') | float(0) %}
          {% set power_in = states('sensor.delta_pro_3_total_input_power') | float(0) %}
          
          {% if power_in > 0 %}
            {% set needed_wh = (capacity * (100 - soc) / 100) %}
            {% set hours = needed_wh / power_in %}
            {{ (hours * 60) | round(0) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "min"
        device_class: duration
        icon: mdi:battery-charging-outline
        attributes:
          note: "Estimated charge time at current rate"

  - binary_sensor:
      # Low Battery Alert
      - name: "Delta Pro 3 Low Battery"
        unique_id: delta_pro_3_low_battery
        state: >
          {{ states('sensor.delta_pro_3_battery_level_bms') | float(100) < 20 }}
        device_class: battery
        icon: mdi:battery-alert

      # High Temperature Alert
      - name: "Delta Pro 3 High Temperature"
        unique_id: delta_pro_3_high_temperature
        state: >
          {{ states('sensor.delta_pro_3_max_cell_temperature') | float(0) > 45 }}
        device_class: problem
        icon: mdi:thermometer-alert

      # Charging Active
      - name: "Delta Pro 3 Is Charging"
        unique_id: delta_pro_3_is_charging
        state: >
          {{ states('sensor.delta_pro_3_total_input_power') | float(0) > 50 }}
        device_class: battery_charging
        icon: mdi:battery-charging

      # Discharging Active
      - name: "Delta Pro 3 Is Discharging"
        unique_id: delta_pro_3_is_discharging
        state: >
          {{ states('sensor.delta_pro_3_total_output_power') | float(0) > 50 }}
        device_class: power
        icon: mdi:battery-minus

